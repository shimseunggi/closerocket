<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rocket Sim (MVP)</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    canvas { border: 1px solid #ddd; border-radius: 12px; }
    .panel { min-width: 280px; padding: 12px; border: 1px solid #eee; border-radius: 12px; }
    label { display: block; margin: 10px 0 4px; }
    input[type="range"] { width: 100%; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h2>Web Rocket Sim (MVP)</h2>

  <div class="row">
    <canvas id="cv" width="520" height="520"></canvas>

    <div class="panel">
      <div class="row">
        <button id="btnReset">Reset</button>
        <button id="btnPlay">Play</button>
        <button id="btnStep">Step</button>
      </div>

      <label>추력 T (N): <span class="mono" id="vT"></span></label>
      <input id="T" type="range" min="0" max="5000" value="2000" step="10"/>

      <label>연료 질량 (kg): <span class="mono" id="vFuel"></span></label>
      <input id="fuel" type="range" min="0" max="200" value="80" step="1"/>

      <label>건조 질량 (kg): <span class="mono" id="vDry"></span></label>
      <input id="dry" type="range" min="20" max="200" value="60" step="1"/>

      <label>Isp (s): <span class="mono" id="vIsp"></span></label>
      <input id="isp" type="range" min="100" max="350" value="230" step="1"/>

      <label>Cd (항력계수): <span class="mono" id="vCd"></span></label>
      <input id="cd" type="range" min="0" max="2" value="0.5" step="0.01"/>

      <label>단면적 A (m²): <span class="mono" id="vA"></span></label>
      <input id="A" type="range" min="0.01" max="1.0" value="0.08" step="0.01"/>

      <hr />
      <div class="mono" id="readout"></div>
      <small style="opacity:.7">* 단순 1D(수직) + 일정 rho, g. 처음 MVP용입니다.</small>
    </div>
  </div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

const el = (id)=>document.getElementById(id);
const ui = {
  T: el('T'), fuel: el('fuel'), dry: el('dry'), isp: el('isp'), cd: el('cd'), A: el('A'),
  vT: el('vT'), vFuel: el('vFuel'), vDry: el('vDry'), vIsp: el('vIsp'), vCd: el('vCd'), vA: el('vA'),
  readout: el('readout'),
  btnReset: el('btnReset'), btnPlay: el('btnPlay'), btnStep: el('btnStep')
};

function syncLabels(){
  ui.vT.textContent = ui.T.value;
  ui.vFuel.textContent = ui.fuel.value;
  ui.vDry.textContent = ui.dry.value;
  ui.vIsp.textContent = ui.isp.value;
  ui.vCd.textContent = Number(ui.cd.value).toFixed(2);
  ui.vA.textContent = Number(ui.A.value).toFixed(2);
}
['T','fuel','dry','isp','cd','A'].forEach(id=> ui[id].addEventListener('input', syncLabels));
syncLabels();

// --- Physics (1D vertical) ---
const g0 = 9.80665;
const rho = 1.225;       // kg/m^3 (sea level, constant for MVP)
let state;

function reset(){
  state = {
    t: 0,
    y: 0,        // altitude (m)
    v: 0,        // velocity (m/s)
    fuel: Number(ui.fuel.value),
    dry: Number(ui.dry.value),
    maxY: 0,
    done: false
  };
}
reset();

function step(dt){
  if(state.done) return;

  const T = Number(ui.T.value);
  const Isp = Number(ui.isp.value);
  const Cd = Number(ui.cd.value);
  const A = Number(ui.A.value);

  let m = state.dry + state.fuel;

  // thrust only while fuel remains
  let thrust = 0;
  let mdot = 0;
  if(state.fuel > 0 && T > 0){
    thrust = T;
    mdot = thrust / (Isp * g0); // kg/s
  }

  // drag: opposite to velocity
  const v = state.v;
  const dragMag = 0.5 * rho * Cd * A * v * v;
  const drag = (v >= 0) ? -dragMag : dragMag;

  // net force
  const F = thrust + drag - m * g0;
  const a = F / m;

  // integrate (semi-implicit Euler: 조금 더 안정적)
  state.v += a * dt;
  state.y += state.v * dt;

  // fuel burn
  if(state.fuel > 0 && mdot > 0){
    state.fuel = Math.max(0, state.fuel - mdot * dt);
  }

  state.t += dt;
  state.maxY = Math.max(state.maxY, state.y);

  // stop if hits ground after launch
  if(state.t > 0.5 && state.y <= 0 && state.v < 0){
    state.y = 0;
    state.done = true;
  }
}

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // simple ground + scale
  ctx.fillStyle = "#f6f6f6";
  ctx.fillRect(0,0,cv.width,cv.height);
  ctx.fillStyle = "#ddd";
  ctx.fillRect(0, cv.height-40, cv.width, 40);

  // map altitude to screen
  const marginTop = 20;
  const maxDisplay = Math.max(200, state.maxY * 1.1);
  const yPix = (alt)=> {
    const h = cv.height - 40 - marginTop;
    const norm = alt / maxDisplay;
    return (cv.height - 40) - norm * h;
  };

  // rocket
  const x = cv.width/2;
  const y = yPix(state.y);
  ctx.save();
  ctx.translate(x,y);

  ctx.fillStyle = "#111";
  ctx.beginPath();
  ctx.moveTo(0,-18);
  ctx.lineTo(10,18);
  ctx.lineTo(-10,18);
  ctx.closePath();
  ctx.fill();

  // flame if thrusting
  const T = Number(ui.T.value);
  if(state.fuel > 0 && T > 0 && !state.done){
    ctx.fillStyle = "orange";
    ctx.beginPath();
    ctx.moveTo(0, 30);
    ctx.lineTo(6, 18);
    ctx.lineTo(-6, 18);
    ctx.closePath();
    ctx.fill();
  }
  ctx.restore();

  // altitude ticks
  ctx.fillStyle = "#666";
  ctx.font = "12px system-ui";
  ctx.fillText(`0 m`, 10, cv.height-45);
  ctx.fillText(`${Math.round(maxDisplay)} m`, 10, marginTop+10);

  // readout
  ui.readout.innerHTML =
    `t=${state.t.toFixed(2)} s<br>`+
    `alt=${state.y.toFixed(1)} m<br>`+
    `v=${state.v.toFixed(1)} m/s<br>`+
    `fuel=${state.fuel.toFixed(2)} kg<br>`+
    `max alt=${state.maxY.toFixed(1)} m<br>`+
    `${state.done ? '<b>Done</b>' : ''}`;
}

let playing = false;
let last = performance.now();

function loop(now){
  const dt = Math.min(0.02, (now - last)/1000); // cap
  last = now;
  if(playing){
    // substeps for stability
    const sub = 4;
    for(let i=0;i<sub;i++) step(dt/sub);
  }
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

ui.btnReset.onclick = ()=>{ reset(); };
ui.btnPlay.onclick = ()=>{
  playing = !playing;
  ui.btnPlay.textContent = playing ? "Pause" : "Play";
};
ui.btnStep.onclick = ()=>{ step(0.02); };
</script>
</body>
</html>
